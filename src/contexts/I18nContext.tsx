import React, { createContext, useContext, useMemo, useState } from 'react';

export type Language = 'en' | 'bg';

type TranslationMap = Record<string, string>;

const translations: Record<Language, TranslationMap> = {
  en: {
    'lang.en': 'EN',
    'lang.bg': 'BG',
    'common.back': 'Back',
    'common.exit': 'Exit',
    'common.home': 'Home',
    'common.loading': 'Loading...',
    'common.signIn': 'Sign In',
    'common.signOut': 'Sign Out',
    'common.getStarted': 'Get Started',
    'common.create': 'Create',
    'common.join': 'Join',
    'common.leave': 'Leave',
    'common.playing': 'Playing',
    'common.you': '(You)',
    'common.host': '(Host)',
    'common.points': 'points',

    'index.badge': 'Build Feynman Diagrams',
    'index.heroTitle1': 'Master Quantum',
    'index.heroTitle2': 'Particle Physics',
    'index.heroSubtitle': 'Discover the fundamental rules of the universe by connecting quarks, electrons, photons and more to create valid Feynman diagrams. Compete with friends or players worldwide!',
    'index.playAi': 'Play vs AI',
    'index.localMultiplayer': 'Local Multiplayer',
    'index.playOnline': 'Play Online',
    'index.howToPlay': 'How to Play',
    'index.features.title': 'Choose Your Mode',
    'index.features.subtitle': 'Play with friends on the same device or challenge players around the world',
    'index.feature1.title': '5 Particle Types',
    'index.feature1.desc': 'Master quarks, electrons, photons, gluons, and the elusive Higgs boson.',
    'index.feature2.title': 'Strategic Gameplay',
    'index.feature2.desc': 'Create valid vertices based on real particle physics rules to score points.',
    'index.feature3.title': 'Global Leaderboard',
    'index.feature3.desc': 'Compete for the highest scores and climb the ranks worldwide.',
    'index.mode.ai.desc': 'Challenge the computer with 3 difficulty levels!',
    'index.mode.local.desc': 'Pass & play with 2-4 players on the same device.',
    'index.mode.online.desc': 'Create or join games with players worldwide.',
    'index.mode.startGame': 'Start Game',
    'index.mode.playNow': 'Play Now',
    'index.cta.title': 'View the Leaderboard',
    'index.cta.desc': "See who's mastered the quantum realm and aim for the top!",
    'index.cta.button': 'View Rankings',
    'index.footer.credit': 'Based on the board game by EPFL+ECAL LAB & Helvetiq',
    'index.footer': 'Tutti Quantum • Learn particle physics through play',
    'index.playerFallback': 'Player',

    'login.welcomeBack': 'Welcome Back',
    'login.subtitle': 'Sign in to continue your quantum journey',
    'login.signingIn': 'Signing in...',
    'login.email': 'Email',
    'login.password': 'Password',
    'login.emailPlaceholder': 'physicist@cern.ch',
    'login.noAccount': "Don't have an account?",
    'login.signUp': 'Sign up',
    'login.success': 'Welcome back!',

    'register.title': 'Join the Experiment',
    'register.subtitle': 'Create your account to start building Feynman diagrams',
    'register.creating': 'Creating account...',
    'register.createAccount': 'Create Account',
    'register.haveAccount': 'Already have an account?',
    'register.signIn': 'Sign in',
    'register.success': 'Account created! Welcome to Tutti Quantum!',
    'register.username': 'Username',
    'register.email': 'Email',
    'register.password': 'Password',
    'register.confirmPassword': 'Confirm Password',
    'register.usernamePlaceholder': 'quantum_physicist',
    'register.emailPlaceholder': 'physicist@cern.ch',
    'register.error.usernameMin': 'Username must be at least 3 characters',
    'register.error.usernameMax': 'Username must be less than 20 characters',
    'register.error.usernamePattern': 'Username can only contain letters, numbers, and underscores',
    'register.error.invalidEmail': 'Invalid email address',
    'register.error.passwordMin': 'Password must be at least 6 characters',
    'register.error.passwordMatch': "Passwords don't match",

    'leaderboard.title': 'Leaderboard',
    'leaderboard.competitive': 'Competitive',
    'leaderboard.cooperative': 'Cooperative',
    'leaderboard.empty': 'No entries yet. Be the first to play!',
    'leaderboard.unknown': 'Unknown Player',
    'leaderboard.valid': 'valid',

    'howToPlay.title': 'How to Play',
    'howToPlay.backHome': 'Back to Home',
    'howToPlay.tab.basics': 'Basics',
    'howToPlay.tab.particles': 'Particles',
    'howToPlay.tab.vertices': 'Vertices',
    'howToPlay.tab.scoring': 'Scoring',

    'notFound.message': 'Oops! Page not found',
    'notFound.returnHome': 'Return to Home',

    'local.round': 'Round {round}/{maxRounds}',
    'local.turn': "{name}'s Turn",
    'local.availableCards': 'Available Cards',
    'local.diagram': "{name}'s Diagram",
    'local.started': "Game started! {name}'s turn.",
    'local.nextTurn': "{name}'s turn",
    'local.invalidPlacement': 'Illegal placement. Card cannot connect legally at that position.',
    'local.gameFinished': 'Game Finished!',
    'local.setupTitle': 'Local Multiplayer',
    'local.setupSubtitle': 'Pass & play on the same device',
    'local.playerCount': 'Number of Players',
    'local.playerLabel': 'Player {index}',
    'local.playerPlaceholder': 'Enter player {index} name',
    'local.cancel': 'Cancel',
    'local.startGame': 'Start Game',
    'local.gameOver': 'Game Over!',
    'local.winner': 'Winner',
    'local.playAgain': 'Play Again',

    'ai.title': 'Play vs AI',
    'ai.yourTurn': 'Your Turn',
    'ai.thinking': '{name} is thinking...',
    'ai.availableCards': 'Available Cards',
    'ai.yourDiagram': 'Your Diagram',
    'ai.aiDiagram': "{name}'s Diagram",
    'ai.aiPlaced': '{name} placed a card. Your turn!',
    'ai.invalidPlacement': 'Illegal placement. Card cannot connect legally at that position.',
    'ai.started': 'Game started! Your turn.',
    'ai.enterName': 'Please enter your name',
    'ai.setupTitle': 'Play vs AI',
    'ai.setupSubtitle': 'Challenge the computer to a quantum duel!',
    'ai.yourName': 'Your Name',
    'ai.namePlaceholder': 'Enter your name',
    'ai.difficulty': 'Difficulty',
    'ai.easy': 'Easy',
    'ai.medium': 'Medium',
    'ai.hard': 'Hard',
    'ai.easyDesc': 'Electron Bot',
    'ai.mediumDesc': 'Gluon AI',
    'ai.hardDesc': 'Higgs Master',
    'ai.cancel': 'Cancel',
    'ai.startGame': 'Start Game',
    'ai.gameOver': 'Game Over!',
    'ai.congrats': 'Congratulations!',
    'ai.youWon': 'You Won!',
    'ai.tryAgain': 'Better luck next time!',
    'ai.wins': '{name} Wins',
    'ai.playAgain': 'Play Again',

    'online.title': 'Online Multiplayer',
    'online.connected': 'Connected',
    'online.createGame': 'Create Game',
    'online.joinGame': 'Join Game',
    'online.gameLobby': 'Game Lobby',
    'online.gameCode': 'Game Code',
    'online.players': 'Players ({count}/{max})',
    'online.waiting': 'Waiting...',
    'online.needSignIn': 'You need to sign in to play online multiplayer.',
    'online.signInRequired': 'Sign In Required',
    'online.yourTurn': 'Your Turn',
    'online.turnPlayer': "{name}'s Turn",
    'online.availableCards': 'Available Cards',
    'online.yourDiagram': 'Your Diagram',
    'online.gameStarted': 'Game started!',
    'online.joined': 'Joined game!',
    'online.left': 'Left game',
    'online.roundStarted': 'Round {round} started!',
    'online.invalidPlacement': 'Illegal placement. Card cannot connect legally at that position.',
    'online.cancelled': 'Game cancelled because a player disconnected.',
    'online.cancelledTitle': 'Game Cancelled',
    'online.cancelledReason': 'A player disconnected.',
    'online.onlineMenu': 'Online Menu',
    'online.copyCode': 'Code copied!',
    'online.needSignInCreate': 'Please sign in to create a game',
    'online.needSignInJoin': 'Please sign in to join a game',
    'online.invalidCode': 'Please enter a valid 6-character game code',
    'online.gameNotFound': 'Game not found',
    'online.alreadyStarted': 'This game has already started',
    'online.gameFull': 'Game is full',
    'online.needMinPlayers': 'Need at least 2 players to start',
    'online.gameFinished': 'Game finished!',
    'online.createTitle': 'Create Game',
    'online.playerCount': 'Number of Players',
    'online.playersSuffix': 'Players',
    'online.joinTitle': 'Join Game',
    'online.codePlaceholder': 'Enter 6-character code',
    'online.start': 'Start',

  },
  bg: {
    'lang.en': 'АНГ',
    'lang.bg': 'БГ',
    'common.back': 'Назад',
    'common.exit': 'Изход',
    'common.home': 'Начало',
    'common.loading': 'Зареждане...',
    'common.signIn': 'Вход',
    'common.signOut': 'Изход от профила',
    'common.getStarted': 'Започни',
    'common.create': 'Създай',
    'common.join': 'Присъедини се',
    'common.leave': 'Напусни',
    'common.playing': 'Играе',
    'common.you': '(Ти)',
    'common.host': '(Домакин)',
    'common.points': 'точки',

    'index.badge': 'Изграждай диаграми на Файнман',
    'index.heroTitle1': 'Овладей квантовата',
    'index.heroTitle2': 'физика на частиците',
    'index.heroSubtitle': 'Открий правилата на Вселената, свързвайки кварки, електрони, фотони и още частици, за да създаваш валидни диаграми на Файнман. Състезавай се с приятели или играчи по света!',
    'index.playAi': 'Играй срещу AI',
    'index.localMultiplayer': 'Локален мултиплейър',
    'index.playOnline': 'Играй онлайн',
    'index.howToPlay': 'Как се играе',
    'index.features.title': 'Избери режим',
    'index.features.subtitle': 'Играй с приятели на едно устройство или предизвикай играчи по света',
    'index.feature1.title': '5 типа частици',
    'index.feature1.desc': 'Овладей кварки, електрони, фотони, глуони и неуловимия Хигс бозон.',
    'index.feature2.title': 'Стратегически геймплей',
    'index.feature2.desc': 'Създавай валидни върхове по реални физични правила и печели точки.',
    'index.feature3.title': 'Глобална класация',
    'index.feature3.desc': 'Състезавай се за най-висок резултат и се изкачи в класацията.',
    'index.mode.ai.desc': 'Предизвикай компютъра с 3 нива на трудност!',
    'index.mode.local.desc': 'Играй на едно устройство с 2-4 играчи.',
    'index.mode.online.desc': 'Създай или се присъедини към игра с хора от цял свят.',
    'index.mode.startGame': 'Започни игра',
    'index.mode.playNow': 'Играй сега',
    'index.cta.title': 'Виж класацията',
    'index.cta.desc': 'Виж кой владее квантовия свят и се цели в върха!',
    'index.cta.button': 'Виж класиране',
    'index.footer.credit': 'По мотиви от настолната игра на EPFL+ECAL LAB & Helvetiq',
    'index.footer': 'Tutti Quantum • Учи физика на частиците чрез игра',
    'index.playerFallback': 'Играч',

    'login.welcomeBack': 'Добре дошъл отново',
      'login.email': 'Имейл',
      'login.password': 'Парола',
      'login.emailPlaceholder': 'physicist@cern.ch',
    'login.subtitle': 'Влез, за да продължиш квантовото си пътешествие',
    'login.signingIn': 'Влизане...',
    'login.noAccount': 'Нямаш акаунт?',
    'login.signUp': 'Регистрация',
    'login.success': 'Добре дошъл отново!',

    'register.title': 'Присъедини се към експеримента',
    'register.subtitle': 'Създай акаунт и започни да строиш диаграми на Файнман',
    'register.creating': 'Създаване на акаунт...',
    'register.createAccount': 'Създай акаунт',
    'register.haveAccount': 'Вече имаш акаунт?',
    'register.signIn': 'Вход',
    'register.success': 'Акаунтът е създаден! Добре дошъл в Tutti Quantum!',
    'register.username': 'Потребителско име',
    'register.email': 'Имейл',
    'register.password': 'Парола',
    'register.confirmPassword': 'Потвърди парола',
    'register.usernamePlaceholder': 'quantum_physicist',
    'register.emailPlaceholder': 'physicist@cern.ch',
    'register.error.usernameMin': 'Потребителското име трябва да е поне 3 символа',
    'register.error.usernameMax': 'Потребителското име трябва да е под 20 символа',
    'register.error.usernamePattern': 'Позволени са само букви, цифри и долна черта',
    'register.error.invalidEmail': 'Невалиден имейл адрес',
    'register.error.passwordMin': 'Паролата трябва да е поне 6 символа',
    'register.error.passwordMatch': 'Паролите не съвпадат',

    'leaderboard.title': 'Класация',
    'leaderboard.competitive': 'Състезателен',
    'leaderboard.cooperative': 'Кооперативен',
    'leaderboard.empty': 'Все още няма резултати. Бъди първият!',
    'leaderboard.unknown': 'Неизвестен играч',
    'leaderboard.valid': 'валидни',

    'howToPlay.title': 'Как се играе',
    'howToPlay.backHome': 'Назад към началото',
    'howToPlay.tab.basics': 'Основи',
    'howToPlay.tab.particles': 'Частици',
    'howToPlay.tab.vertices': 'Върхове',
    'howToPlay.tab.scoring': 'Точкуване',

    'notFound.message': 'Опа! Страницата не е намерена',
    'notFound.returnHome': 'Към началото',

    'local.round': 'Рунд {round}/{maxRounds}',
    'local.turn': 'Ход на {name}',
    'local.availableCards': 'Налични карти',
    'local.diagram': 'Диаграма на {name}',
    'local.started': 'Играта започна! Ход на {name}.',
    'local.nextTurn': 'Ход на {name}',
    'local.invalidPlacement': 'Невалидно поставяне. Картата не може да се свърже правилно на тази позиция.',
    'local.gameFinished': 'Край на играта!',
    'local.setupTitle': 'Локален мултиплейър',
    'local.setupSubtitle': 'Подай и играй на едно устройство',
    'local.playerCount': 'Брой играчи',
    'local.playerLabel': 'Играч {index}',
    'local.playerPlaceholder': 'Въведи име на играч {index}',
    'local.cancel': 'Отказ',
    'local.startGame': 'Старт',
    'local.gameOver': 'Край на играта!',
    'local.winner': 'Победител',
    'local.playAgain': 'Играй отново',

    'ai.title': 'Играй срещу AI',
    'ai.yourTurn': 'Твоят ход',
    'ai.thinking': '{name} мисли...',
    'ai.availableCards': 'Налични карти',
    'ai.yourDiagram': 'Твоята диаграма',
    'ai.aiDiagram': 'Диаграма на {name}',
    'ai.aiPlaced': '{name} постави карта. Твоят ход!',
    'ai.invalidPlacement': 'Невалидно поставяне. Картата не може да се свърже правилно на тази позиция.',
    'ai.started': 'Играта започна! Твоят ход.',
    'ai.enterName': 'Моля, въведи име',
    'ai.setupTitle': 'Играй срещу AI',
    'ai.setupSubtitle': 'Предизвикай компютъра в квантов дуел!',
    'ai.yourName': 'Твоето име',
    'ai.namePlaceholder': 'Въведи име',
    'ai.difficulty': 'Трудност',
    'ai.easy': 'Лесно',
    'ai.medium': 'Средно',
    'ai.hard': 'Трудно',
    'ai.easyDesc': 'Електрон бот',
    'ai.mediumDesc': 'Глуон AI',
    'ai.hardDesc': 'Хигс майстор',
    'ai.cancel': 'Отказ',
    'ai.startGame': 'Старт',
    'ai.gameOver': 'Край на играта!',
    'ai.congrats': 'Поздравления!',
    'ai.youWon': 'Победи!',
    'ai.tryAgain': 'Следващия път ще е твой!',
    'ai.wins': '{name} печели',
    'ai.playAgain': 'Играй отново',

    'online.title': 'Онлайн мултиплейър',
    'online.connected': 'Свързан',
    'online.createGame': 'Създай игра',
    'online.joinGame': 'Присъедини се към игра',
    'online.gameLobby': 'Лоби',
    'online.gameCode': 'Код на играта',
    'online.players': 'Играчи ({count}/{max})',
    'online.waiting': 'Изчакване...',
    'online.needSignIn': 'Трябва да влезеш, за да играеш онлайн мултиплейър.',
    'online.signInRequired': 'Необходим е вход',
    'online.yourTurn': 'Твоят ход',
    'online.turnPlayer': 'Ход на {name}',
    'online.availableCards': 'Налични карти',
    'online.yourDiagram': 'Твоята диаграма',
    'online.gameStarted': 'Играта започна!',
    'online.joined': 'Успешно се присъедини!',
    'online.left': 'Напусна играта',
    'online.roundStarted': 'Рунд {round} започна!',
    'online.invalidPlacement': 'Невалидно поставяне. Картата не може да се свърже правилно на тази позиция.',
    'online.cancelled': 'Играта е прекратена, защото играч се е разкачил.',
    'online.cancelledTitle': 'Играта е прекратена',
    'online.cancelledReason': 'Играч се е разкачил.',
    'online.onlineMenu': 'Онлайн меню',
    'online.copyCode': 'Кодът е копиран!',
    'online.needSignInCreate': 'Моля, влез в профила си, за да създадеш игра',
    'online.needSignInJoin': 'Моля, влез в профила си, за да се присъединиш',
    'online.invalidCode': 'Моля, въведи валиден 6-символен код',
    'online.gameNotFound': 'Играта не е намерена',
    'online.alreadyStarted': 'Тази игра вече е започнала',
    'online.gameFull': 'Играта е пълна',
    'online.needMinPlayers': 'Нужни са поне 2 играчи за старт',
    'online.gameFinished': 'Играта приключи!',
    'online.createTitle': 'Създай игра',
    'online.playerCount': 'Брой играчи',
    'online.playersSuffix': 'играчи',
    'online.joinTitle': 'Присъедини се към игра',
    'online.codePlaceholder': 'Въведи 6-символен код',
    'online.start': 'Старт',
  },
};

interface I18nContextType {
  language: Language;
  setLanguage: (language: Language) => void;
  t: (key: string, vars?: Record<string, string | number>) => string;
}

const I18nContext = createContext<I18nContextType | undefined>(undefined);

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [language, setLanguageState] = useState<Language>(() => {
    const saved = localStorage.getItem('tutti_language');
    return saved === 'bg' ? 'bg' : 'en';
  });

  const setLanguage = (next: Language) => {
    setLanguageState(next);
    localStorage.setItem('tutti_language', next);
  };

  const t = (key: string, vars?: Record<string, string | number>): string => {
    const base = translations[language][key] ?? translations.en[key] ?? key;
    if (!vars) return base;

    return Object.entries(vars).reduce((acc, [varKey, varValue]) => {
      return acc.replace(new RegExp(`\\{${varKey}\\}`, 'g'), String(varValue));
    }, base);
  };

  const value = useMemo(() => ({ language, setLanguage, t }), [language]);

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used within an I18nProvider');
  }
  return context;
}
